<!DOCTYPE HTML>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />
<title>TRANS-TI | Negocios</title>
<script type="text/javascript" src="cordova.js"></script>
<link rel="stylesheet" type="text/css" href="styles/style.css">
<link rel="stylesheet" type="text/css" href="fonts/css/fontawesome-all.min.css">
<link rel="stylesheet" type="text/css" href="styles/framework.css">
<link href="https://fonts.googleapis.com/css?family=Poppins:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i|Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i" rel="stylesheet">
</head>

<body>

<div id="preloader" class="preloader-light">
	<h1 class="center-text color-black ultrabold uppercase bottom-0 fa-2x">Trans-TI</h1>
	<div id="preload-spinner"></div>
	<p>Innovacion Tecnologica</p>
	<em>Estamos cargando, aguarde un segundo ¡Vale la Pena!</em>
</div>


<div id="page-transitions" class="page-build">
    <div class="page-bg gradient-body-1"></div>

	<!--div class="header shadow-large header-light header-logo-app">
		<a href="index.html" class="header-logo"></a>
        <a id="i_ok_login" href="#" class="header-icon header-icon-1" style="display:none"><i class="fas fa-check-circle"></i></a>
        <a id="i_no_login" href="#" class="header-icon header-icon-1"><i class="fas fa-times-circle"></i></a>
		<a data-menu="menu-settings" data-menu-type="menu-box-full" id="b_abrirLogin" href="#" class="header-icon header-icon-2"><i class="fas fa-cog fa-spin font-12"></i></a>
    </div-->

	<!--div id="menu-1" class="menu menu-sidebar-left menu-settings">
        <div class="menu-bg gradient-body-1"></div>
        <div class="menu-scroll">
            <div class="menu-header">
                <a class="menu-logo" href="index.html"></a>
                <h1>Bienvenidos</h1>
                <p>Negocios</p>
            </div>
            <div class="menu-list icon-background-active">
                <em class="menu-divider top-10">Navegacion</em>
                <a class="menu-item active-menu" href="index.html"><i class="fa gradient-red-light fa-upload"></i>Carga de Puntos</a>
                <a class="menu-item" href="cargas.html"><i class="fa gradient-green-light fa-list"></i>Listado de Cargas</a>
            </div>
        </div>
	</div-->

	<div class="page-content sheader-clear-larger" style="margin-top:10px;">

        <div class="content-boxed bg-white">
            <div class="decoration opacity-50 bottom-0"></div>
            <div>
                <h1 class="center-text uppercase ultrabold">Carga de datos</h1>
                <p class="boxed-text-large bottom-20">
                    <div class="content-box shadow-large bg-white" style="margin-left: auto;margin-right: auto;">
                        <div class="top-25 bottom-30">
                            <div class="input-simple-2 has-icon input-green bottom-30">
                                <em style="display:block">Telefono</em>
                                <input id="i_area" type="number" value="54911" placeholder="54911 para Argentina" style="width: 18%;display:inline">
                                <input id="i_telefono" type="number" placeholder="Telefono sin 54911"style="width: 30%;display:inline;">
                            </div>

                                <fieldset style="border: 1px solid #000000;
                                font-size: 11px;
                                line-height: 11px;
                                padding: 8px;
                                position: absolute;
                                width: 50%;
                                top: 15%;
                                left: 50%;
                                height: 90px;">
                                    <legend>Datos Cliente</legend>
                                    <div style="border-bottom:1px solid black;text-align: center;">
                                        <b id="l_nombre">-</b>
                                    </div>
                                    <div style="text-align: center;font-size: 29pt;top: 19px;">
                                        <b id="l_puntos">-</b>
                                    </div>


                                </fieldset>

                            <div class="input-simple-2 has-icon input-green bottom-30">
                                <em>DNI</em>
                                <input id="i_dni" type="number" placeholder="DNI" style="width: 47%">
                            </div>
                            <div class="input-simple-1 has-icon input-green bottom-30">
                                <strong>Requerido</strong>
                                <em>Monto</em>
                                <input id="i_monto" type="number" placeholder="Monto">
                            </div>

                            <div id="rubros_list">

                            </div>
                            <h1 id="resultado" class="center-text uppercase ultrabold"></h1>
                       </div>
                   </div>
                </p>
                <a href="#" id="b_cargar" class="button button-round button-green button-center-large button-sm uppercase ultrabold shadow-icon-large">Carga de Compra</a>
            </div>
            <div class="decoration opacity-50 bottom-0"></div>
        </div>
     
	</div>

    <div class="menu menu-box-full shadow-large" id="menu-settings">
        <div class="page-bg gradient-body-1">
            <div class="cover-content-center">
                <div class="page-login bg-white top-0">
                    <img class="preload-image login-bg shadow-large responsive-image bottom-0" src="images/pictures/9w.jpg" data-src="images/pictures/9w.jpg" alt="img">
                    <img class="preload-image login-image shadow-icon-large" src="images/pictures/0s.png" data-src="images/pictures/0s.png" alt="img">
                    <div class="content bottom-0">
                        <h3 class="uppercase ultrabold top-10 bottom-0">Ingreso</h3>
                        <p class="smaller-text bottom-15 text-red" id="e_mensaje_login"></p>
                        <div class="page-login-field top-15">
                            <i class="fa fa-user"></i>
                            <input type="text" id="u_usuario" placeholder="Usuario">
                            <em>(requerido)</em>
                        </div>
                        <div class="page-login-field bottom-20">
                            <i class="fa fa-lock"></i>
                            <input type="password" id="p_pass" placeholder="Contraseña">
                            <em>(requerido)</em>
                        </div>
                        <a href="#" class="button button-green button-full shadow-icon-large button-round button-s uppercase ultrabold" id="b_login">LOGIN</a>
                    </div>
                </div>
            </div>
        </div>
    </div>



	<a href="#" class="back-to-top-badge back-to-top-small shadow-large bg-blue-dark"><i class="fa fa-angle-up"></i>Back to Top</a>
</div>


<script type="text/javascript" src="scripts/jquery.js"></script>
<script type="text/javascript" src="scripts/plugins.js"></script>
<script type="text/javascript" src="scripts/custom.js"></script>
<script type="text/javascript">
    /*
    apágar $('#menu-settings').removeClass('active-menu-box-full');
    prender $('#menu-settings').toggleClass('active-menu-box-full');

     */
    var logueado = false;
    //var Connection = navigator.connection;
    var serverAPI="http://exdec.trans-ti.com/exdec/api/";
    //var serverAPI="http://localhost/exdec/api/";
    var store = store || {};
    /*
     * Store JWT
     */
    store.setIDComercio = function (data) {
        this.idComercio=data;
    };
    store.setJWT = function(data) {
        this.JWT = data;
    };
    store.clear = function(data) {
        this.JWT = "";
        this.idComercio = "";
        this.u = "";
        logueado = false;
    };

    var deviceReady = function(){
        if(window.MobileAccessibility){
            window.MobileAccessibility.usePreferredTextZoom(false);
        }
        $("#i_telefono").focus();
        procesarLoginDeLocal();
        document.addEventListener("online", cambioDeConexion, false);
        document.addEventListener("offline", cambioDeConexion, false);
    }

    document.addEventListener('deviceready', deviceReady, false);

    $(function () {
        $("#i_telefono").focus();
        $("#i_telefono").keyup(function (e) {
            leng = $(this).val().length;
            if (e.which == 13 || leng > 7) {
                $("#i_monto").focus();
            }
        });
        $("#i_dni").keyup(function (e) {
            leng = $(this).val().length;
            if (e.which == 13 || leng > 7) {
                $("#i_monto").focus();
            }
        });

        $("#i_telefono").on("blur",function (e) {
            leng = $(this).val().length;
            if (e.which == 13 || leng > 7) {
                var telefono = $("#i_area").val()+''+$(this).val();
                traerIdClienteTelefono(telefono);
            }

        });
        $("#i_dni").on("blur",function (e) {
            leng = $(this).val().length;
            if (e.which == 13 || leng > 7) {
                var dni = $(this).val();
                traerIdClienteDNI(dni);
            }
        });

        $("#i_monto").keyup(function (e) {
            if (e.which == 13) {
                procesarCarga();
            }
        });
        $("#b_cargar").click(function () {
            procesarCarga();
        });
        $("#b_login").click(function () {
            procesarLogin();
        });
        $("#b_abrirLogin").click(function () {
            $("#u_usuario").focus();
        });
        $("#p_pass,#u_usuario").keyup(function (e) {
            if (e.which == 13) {
                procesarLogin();
            }
        });
        if (window.localStorage.u.length > 0) {
            procesarLoginDeLocal();
        } else {
            $('#menu-settings').toggleClass('active-menu-box-full');
        }
    });
    var traerIdClienteTelefono = function (t) {
        if (store.idComercio.length < 1) {
            store.clear();
            $('#menu-settings').toggleClass('active-menu-box-full');
            alert("no tengo id de Comercio!");
            return false;
        }
        var data = {};
        data.action="traerIDCliente";
        data.telefono=t;
        data.comercio_id=store.idComercio;

        $.ajax({
            url: serverAPI,
            type: "POST",
            data: data,
            success: function(data, status, xhr) {
                if (parseInt(data.id) > 0) {
                    store.tmp_cliente_id = data.id;
                    traerDatosClienteDeId(mostrarDatosCliente,data.id);
                } else {
                    $("#i_telefono").val("");
                    $("#i_telefono").focus();
                    alert("cliente no existe");
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                $("#i_telefono").val("");
                $("#i_telefono").focus();
                alert("cliente no existe");
            },
            beforeSend: function(request) { // Set JWT header
                request.setRequestHeader('X-Authorization', 'Bearer ' + store.JWT);
            }
        });
    };

    var traerIdClienteDNI = function (d) {
        if (store.idComercio.length < 1) {
            store.clear();
            $('#menu-settings').toggleClass('active-menu-box-full');
            alert("no tengo id de Comercio!");
            return false;
        }
        var data = {};
        data.action="traerIDClienteDeDNI";
        data.dni=d;
        data.comercio_id=store.idComercio;

        $.ajax({
            url: serverAPI,
            type: "POST",
            data: data,
            success: function(data, status, xhr) {
                if (parseInt(data.id) > 0) {
                    store.tmp_cliente_id = data.id;
                    traerDatosClienteDeId(mostrarDatosCliente,data.id);
                } else {
                    $("#i_dni").val("");
                    $("#i_dni").focus();
                    alert("cliente no existe");
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                $("#i_dni").val("");
                $("#i_dni").focus();
                alert("cliente no existe");
            },
            beforeSend: function(request) { // Set JWT header
                request.setRequestHeader('X-Authorization', 'Bearer ' + store.JWT);
            }
        });
    };

    var traerDatosClienteDeId = function (cb,id) {
        var data = {};
        data.action="traerClienteDeID";
        data.id=id;

        $.ajax({
            url: serverAPI,
            type: "POST",
            data: data,
            success: function(data, status, xhr) {
                if (parseInt(data.id) > 0) {
                    cb(data);
                } else {
                    alert("id no valido, cliente no existe");
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert("id no valido, cliente no existe");
            },
            beforeSend: function(request) { // Set JWT header
                request.setRequestHeader('X-Authorization', 'Bearer ' + store.JWT);
            }
        });
    };

    var mostrarDatosCliente = function (data) {
        //alert(data);
        $("#i_area").val(data.celular.substr(0,5));
        $("#i_telefono").val(data.celular.substr(5));
        $("#i_dni").val(data.dni);
        $("#l_nombre").text(data.apellido + ", " + data.nombre);
        $("#l_puntos").text(data.puntos);

    };
    var procesarLogin = function () {
        var c = {};
        c.u = $("#u_usuario").val();
        c.p = $("#p_pass").val();
        window.localStorage.u = c.u;
        window.localStorage.p = c.p;
        if(c.u.length < 1 || c.p.length < 1) {
            usuarioNo("Se requiere Usuario y Contraseña");
            return false;
        }
        comprobarCredenciales(c);
    };
    var usuarioSi = function () {
        var data = {};
        data.action="list";
        data.object="comercio";
        $.ajax({
            url: serverAPI/*+"?action=list&object=comercio"*/,
            type: "POST",
            data: data,
            success: function(data, status, xhr) {
                var out = (data && typeof data === 'object') ? JSON.stringify(data) : data;
                if (data.success) {
                    store.setIDComercio(data.comercio[0].id);
                    $("#u_usuario").val("");
                    $("#p_pass").val("");
                    $("#i_ok_login").show();
                    $("#i_no_login").hide();
                    //cargarRubros();
                    cerrarMenu();
                    $("#i_telefono").focus();
                } else {
                    usuarioNo(data.failureMessage);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                usuarioNo("error inesperado en encabezados");
            },
            beforeSend: function(request) { // Set JWT header
                request.setRequestHeader('X-Authorization', 'Bearer ' + store.JWT);
            } 
        });

    }

    var usuarioNo = function (mensaje) {
        store.clear();
        $("#i_ok_login").hide();
        $("#i_no_login").show();
        $("#e_mensaje_login").html("");
        $("#e_mensaje_login").append("<div style='margin-top:5px;margin-bottom:5px;padding:5px;' class='demo-line gradient-red-dark'>"+mensaje+"</div>");
        $("#u_usuario").focus();
    }
    var cargaSi = function (f) {

/*        $("#resultado").html("");
        $("#resultado").append("<div class='demo-line gradient-green-dark'>Telefono: "+f.telefono+"<br>RUBROS: "+traerNombreDeRubro_id(f.rubros?f.rubros:0)+"<br>MONTO: "+f.monto+"</div>");
*/
        $("#i_telefono").val("");
        $("#i_dni").val("");
        $("#i_monto").val("");
        /*$("input[name*='rubro[]']:not(:checked)").each(function (i,v) {
            $(v).click();
        });*/
        $(window).scrollTop(0);
        $("#i_telefono").focus();
    };
    var cargaNo = function (m) {
        $("#resultado").html("");
        $("#resultado").append("<div class='demo-line gradient-red-dark'>"+m+"</div>");
    };

    var procesarCarga = function () {
        var f = {};
        f.telefono = $("#i_area").val() + "" + $("#i_telefono").val();
        f.monto = $("#i_monto").val();
        //f.rubros = traerRubrosSeleccionados();
        if (f.telefono.length < 7) {
            $("#i_telefono").focus();
            return false;
        }
        if (!store.JWT || store.JWT.length < 2) {
            store.clear();
            $('#menu-settings').toggleClass('active-menu-box-full');
            return false;
        }
        //f es el form
        conseguirId_telefono_y_enviar(f);
    };

    var conseguirId_telefono_y_enviar = function (f) {
        var data = {};
        data.action="traerIDCliente";
        data.telefono=f.telefono;
        data.comercio_id=store.idComercio;
        $.ajax({
            url: serverAPI,
            type: "POST",
            data: data,
            success: function(data, status, xhr) {
                if (parseInt(data.id) > 0) {
                    f.id_cliente = data.id;
                    enviarCarga(f);
                } else {
                    alert("ERROR, No existe el cliente");
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert("ERROR interno");
            },
            beforeSend: function(request) { // Set JWT header
                request.setRequestHeader('X-Authorization', 'Bearer ' + store.JWT);
            }
        });
    };
    var enviarCarga = function (f) {
        // f.telefono
        // f.monto
        // f.rubros
        // f.id_cliente
        var date = new Date();
        var formattedDate = ('0' + date.getDate()).slice(-2);
        var formattedMonth = ('0' + (date.getMonth() + 1)).slice(-2);
        var formattedYear = date.getFullYear().toString();
        var dateString = formattedMonth + "/" + formattedDate + "/" + formattedYear + " " + date.getUTCHours() + ":" + date.getUTCMinutes() + ":" + date.getUTCSeconds();

        var data = {
            cliente_id: f.id_cliente,
            comercio_id: store.idComercio,
            monto: f.monto/*,
            rubros_id: f.rubros*/
        };

        $.ajax({
            url: serverAPI+"?action=add&object=compra",
            type: "POST",
            data: data,
            success: function(data, status, xhr) {
                if (data.success) {
                    f.compra_id = data.compra.id;
                    traerDatosClienteDeId(mostrarDatosCliente,store.tmp_cliente_id);
                    cargaSi(f);
                } else {
                    alert("ERROR en carga de compra");
                }                
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert("ERROR desconocido");
            },
            beforeSend: function(request) { // Set JWT header
                request.setRequestHeader('X-Authorization', 'Bearer ' + store.JWT);
            } 
        });
    };

    comprobarCredenciales = function (c) {
        //c.u = usuario
        //c.p = password
        //usuarioNo("mensaje");
        //usuarioSi();

        var data = 'username='+c.u+'&password='+c.p+'&action=login';
        $.post(serverAPI, data, function(data) {
            store.setJWT(data.JWT);
            usuarioSi();
        }).fail(function(xhr, status, error) {
            usuarioNo("Usuario o Contraseña no válidos "+error+"-"+status);
        });
        return false;
    };


    function cambioDeConexion() {
        procesarLoginDeLocal();
    }

    var procesarLoginDeLocal = function () {
        var c = {};
        c.p = window.localStorage.p;
        c.u = window.localStorage.u;
        $.post(serverAPI, 'username='+c.u+'&password='+c.p+'&action=login', function(data) {
            store.clear();
            store.setJWT(data.JWT);
            var data = {};
            data.action="list";
            data.object="comercio";
            $.ajax({
                url: serverAPI/*+"?action=list&object=comercio"*/,
                type: "POST",
                data: data,
                success: function(data, status, xhr) {
                    var out = (data && typeof data === 'object') ? JSON.stringify(data) : data;
                    if (data.success) {
                        store.setIDComercio(data.comercio[0].id);
                        $("#u_usuario").val("");
                        $("#p_pass").val("");
                        $("#i_ok_login").show();
                        $("#i_no_login").hide();
                      /*  limpiarRubros();
                        cargarRubros();*/
                    } else {
                        store.clear();
                        window.localStorage.u = "";
                        $('#menu-settings').toggleClass('active-menu-box-full');
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    store.clear();
                    $('#menu-settings').toggleClass('active-menu-box-full');
                },
                beforeSend: function(request) { // Set JWT header
                    request.setRequestHeader('X-Authorization', 'Bearer ' + store.JWT);
                } 
            });
        }).fail(function(xhr, status, error) {
            store.clear();
            $('#menu-settings').toggleClass('active-menu-box-full');
        });
        return false;        
    }
</script>
</body>
